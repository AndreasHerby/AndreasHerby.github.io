import json
import os
from datetime import datetime
from pathlib import Path

PROJECT_ROOT = Path(__file__).resolve().parents[1]
CUSTODY_FILE = PROJECT_ROOT / "logs" / "custody.json"


def load_custody():
    if not os.path.exists(CUSTODY_FILE):
        return {}

    with open(CUSTODY_FILE, "r") as f:
        return json.load(f)


def hash_exists(sha256_hash: str) -> bool:
    custody_storage = load_custody()
    return sha256_hash in custody_storage



def log_file(filename, sha256_hash: str, file_type: str, quarantined_path: str, source: str = "uploads"):
    try:
        with open(CUSTODY_FILE, "r") as f:
            custody_storage = json.load(f)

    except FileNotFoundError:
        custody_storage = {}

    custody_storage[sha256_hash] = {
        "original_name": filename,
        "file_type": file_type,
        "quarantined_path": quarantined_path,
        "source": source,
        "timestamp": datetime.utcnow().isoformat() + "Z"
    }

    with open(CUSTODY_FILE, "w") as f:
        json.dump(custody_storage, f, indent=4)

