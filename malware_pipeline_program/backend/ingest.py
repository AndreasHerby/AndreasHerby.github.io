import os
from pathlib import Path
from backend.hashing import compute_sha256
from backend.filetype import detect_file_type
from backend.quarantine import quarantine_file
from backend.custody import hash_exists, log_file

def validate_input_directory(input_dir: str):
    if not os.path.exists(input_dir):
        raise FileNotFoundError(f"Input directory does not exist: {input_dir}")
    if not os.path.isdir(input_dir):
        raise NotADirectoryError(f"Path is not a directory: {input_dir}")
    if not os.listdir(input_dir):
        print(f"Warning: Input directory is empty: {input_dir}")


def process_input_directory(input_dir: str, source: str = "uploads"):
    validate_input_directory(input_dir)

    for filename in os.listdir(input_dir):
        file_path = Path(input_dir) / filename

        if not os.path.isfile(file_path):
            continue

        sha = compute_sha256(file_path)

        if hash_exists(sha):
            print(f"Duplicate detected: {filename}")
            continue

        file_type = detect_file_type(str(file_path))
        quarantined_path = quarantine_file(str(file_path), sha)
        log_file(filename, sha, file_type, quarantined_path, file_path.suffix, source)

        print(f"Processed: {filename} -> {file_type}, quarantined at {quarantined_path}")





