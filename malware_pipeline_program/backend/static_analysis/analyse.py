import json
from pathlib import Path
from backend.custody import hash_exists
from datetime import datetime, timezone

from entropy import calculate_entropy
from static_metadata import extract_metadata
from strings import extract_strings
from backend.custody import load_custody

PROJECT_PATH = Path(__file__).resolve().parents[2]
QUARANTINE_PATH = PROJECT_PATH / "quarantine"
ANALYSIS_PATH = PROJECT_PATH / "logs" / "analysis"
ANALYSIS_PATH.mkdir(parents=True, exist_ok=True)



def analyse_file(file_path: Path) -> dict:
    custody = load_custody()

    sha256 = file_path.name  # SHA from Phase 1
    metadata = extract_metadata(file_path)
    entropy_value = calculate_entropy(file_path)
    strings_result = extract_strings(file_path)
    file_type = custody[sha256]["file_type"]
    system_extension = custody[sha256]["system_extension"]

    return {
        "sha256": sha256,
        "analysis_timestamp": datetime.now(timezone.utc).isoformat(),
        "file_path": str(file_path.relative_to(PROJECT_PATH)),
        "metadata": metadata,
        "entropy": {
            "shannon_entropy": round(entropy_value, 4),
            "assessment": "high" if entropy_value > 6.5 else "medium" if entropy_value > 5 else "low"
        },
        "strings": strings_result,
        "File type validation": {
            "File type": file_type,
            "System extension": system_extension,
            "Mismatch": True if file_type != system_extension.lstrip(".") else False

        }
    }


def run_analysis():
    files = [f for f in QUARANTINE_PATH.iterdir() if f.is_file()]
    if not files:
        print("[!] No files found in quarantine.")
        return

    for file_path in files:
        if not hash_exists(file_path.name):
            print(f"[!] SHA {file_path.name} not found in custody, skipping.")
            continue

        report = analyse_file(file_path)
        output_file = ANALYSIS_PATH / f"{file_path.name}.json"
        with output_file.open("w", encoding="utf-8") as f:
            json.dump(report, f, indent=4)
        print(f"[+] Analysed {file_path.name}")


run_analysis()


